version: '3.8'

services:
  # Apache + mod_wsgi for Django
  apache-django:
    build:
      context: ./django
      dockerfile: ../docker/Dockerfile.django-apache
    ports:
      - "8080:80"
    volumes:
      - ./django:/var/www/django
      - ./django/static:/var/www/django/static
    environment:
      - DEBUG=True
      - PYTHONUNBUFFERED=1
    networks:
      - app-network

  # Drupal CMS (separate Apache)
  drupal:
    image: drupal:11-apache
    ports:
      - "8081:80"
    volumes:
      - ./drupal/web:/opt/drupal/web
      - ./drupal/recipes:/opt/drupal/recipes
      - ./drupal/composer.json:/var/www/html/composer.json
      - ./docker/drupal-startup.sh:/usr/local/bin/drupal-startup.sh
      - drupal_sites:/opt/drupal/web/sites
      - drupal_modules:/opt/drupal/web/modules
      - drupal_profiles:/opt/drupal/web/profiles
      - drupal_themes:/opt/drupal/web/themes
    command: ["bash", "/usr/local/bin/drupal-startup.sh"]
    environment:
      # Drupal database configuration for RDS
      DRUPAL_DB_HOST: ${RDS_HOST}
      DRUPAL_DB_USER: ${RDS_USER}
      DRUPAL_DB_PASSWORD: ${RDS_PASSWORD}
      DRUPAL_DB_NAME: ${RDS_DATABASE}
      DRUPAL_DB_PORT: 3306
      DRUPAL_DB_DRIVER: mysql
    networks:
      - app-network

volumes:
  drupal_sites:
  drupal_modules:
  drupal_profiles:
  drupal_themes:

networks:
  app-network:
    driver: bridge
